<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Gallery.App.ViewModels"
             xmlns:converters="clr-namespace:Gallery.App.Converters"
             xmlns:index="clr-namespace:Gallery.Domain.Index;assembly=Gallery.Domain"
             x:Class="Gallery.App.Views.GalleryPage"
             x:DataType="vm:GalleryViewModel"
             Title="NextGallery">

    <ContentPage.Resources>
        <converters:BannerVisibilityConverter x:Key="BannerVisibility" />
        <converters:BannerSeverityColorConverter x:Key="BannerColor" />
        <converters:IsNotNullOrEmptyConverter x:Key="IsNotNullOrEmpty" />
        <converters:JobRowToThumbnailConverter x:Key="JobToThumbnail" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Banner (always present, collapsed when none) -->
        <Frame Grid.Row="0"
               IsVisible="{Binding Banner, Converter={StaticResource BannerVisibility}}"
               BackgroundColor="{Binding Banner, Converter={StaticResource BannerColor}}"
               Padding="12,8"
               CornerRadius="0"
               Margin="0">
            <HorizontalStackLayout Spacing="8">
                <Label Text="{Binding Banner.Message}"
                       VerticalOptions="Center"
                       FontSize="14" />
                <Label Text="{Binding Banner.SkippedCount, StringFormat='({0} skipped)'}"
                       IsVisible="{Binding Banner.SkippedCount, Converter={StaticResource IsNotNullOrEmpty}}"
                       VerticalOptions="Center"
                       FontSize="12"
                       TextColor="DimGray" />
            </HorizontalStackLayout>
        </Frame>

        <!-- State-specific content -->
        <Grid Grid.Row="1">
            <!-- Loading State -->
            <VerticalStackLayout IsVisible="{Binding CurrentViewState, Converter={x:Static vm:GalleryViewStateConverters.IsLoading}}"
                                 VerticalOptions="Center" HorizontalOptions="Center" Spacing="16">
                <ActivityIndicator IsRunning="True" HeightRequest="48" WidthRequest="48" Color="#9B7DD4" />
                <Label Text="Loading..." FontSize="18" HorizontalOptions="Center" />
            </VerticalStackLayout>

            <!-- Empty State -->
            <VerticalStackLayout IsVisible="{Binding CurrentViewState, Converter={x:Static vm:GalleryViewStateConverters.IsEmpty}}"
                                 VerticalOptions="Center" HorizontalOptions="Center" Spacing="16" Padding="32">
                <Label Text="No images found"
                       FontSize="24"
                       FontAttributes="Bold"
                       HorizontalOptions="Center" />
                <Label Text="Add images to this folder or select a different folder."
                       FontSize="14"
                       TextColor="Gray"
                       HorizontalOptions="Center"
                       HorizontalTextAlignment="Center" />
                <Button Text="Browse Folder..."
                        Command="{Binding BrowseFolderCommand}"
                        BackgroundColor="#9B7DD4"
                        TextColor="White"
                        HorizontalOptions="Center"
                        Margin="0,16,0,0" />
                <Button Text="Refresh"
                        Command="{Binding RefreshCommand}"
                        BackgroundColor="#3D3D3D"
                        TextColor="White"
                        HorizontalOptions="Center" />
            </VerticalStackLayout>

            <!-- List State -->
            <Grid IsVisible="{Binding CurrentViewState, Converter={x:Static vm:GalleryViewStateConverters.IsList}}"
                  RowDefinitions="Auto,*">
                <!-- Header -->
                <HorizontalStackLayout Grid.Row="0" Padding="16,8" Spacing="12" BackgroundColor="#2D2D2D">
                    <Button Text="ðŸ“"
                            Command="{Binding BrowseFolderCommand}"
                            BackgroundColor="#4D4D4D"
                            TextColor="White"
                            VerticalOptions="Center"
                            Padding="10,6"
                            ToolTipProperties.Text="Browse for folder..." />
                    <Label Text="{Binding SourceName}"
                           VerticalOptions="Center"
                           FontSize="14"
                           TextColor="#9B7DD4" />
                    <Label Text="{Binding Jobs.Count, StringFormat='{0} items'}"
                           VerticalOptions="Center"
                           FontSize="16"
                           FontAttributes="Bold" />
                    <Button Text="Refresh"
                            Command="{Binding RefreshCommand}"
                            BackgroundColor="#9B7DD4"
                            TextColor="White"
                            VerticalOptions="Center"
                            Padding="12,6" />
                    <Button Text="Open in Explorer"
                            Command="{Binding OpenOutputsFolderCommand}"
                            BackgroundColor="#3D3D3D"
                            TextColor="White"
                            VerticalOptions="Center"
                            Padding="12,6" />
                    <ActivityIndicator IsRunning="{Binding IsRefreshing}"
                                       IsVisible="{Binding IsRefreshing}"
                                       HeightRequest="20"
                                       WidthRequest="20"
                                       Color="#9B7DD4"
                                       VerticalOptions="Center" />
                </HorizontalStackLayout>

                <!-- Job List -->
                <CollectionView Grid.Row="1"
                                ItemsSource="{Binding Jobs}"
                                SelectedItem="{Binding SelectedJob}"
                                SelectionMode="Single"
                                BackgroundColor="#1E1E1E">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="index:JobRow">
                            <Frame Margin="8,4" Padding="12" BackgroundColor="#2D2D2D" BorderColor="#3D3D3D" CornerRadius="8">
                                <Grid ColumnDefinitions="60,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="12">
                                    <!-- Type Icon -->
                                    <Border Grid.RowSpan="3"
                                            BackgroundColor="#3D3D3D"
                                            WidthRequest="60"
                                            HeightRequest="60"
                                            StrokeShape="RoundRectangle 4">
                                        <Label Text="{Binding Kind}"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center"
                                               TextColor="#9B7DD4"
                                               FontSize="11" />
                                    </Border>

                                    <!-- Job Info -->
                                    <Label Grid.Column="1" Grid.Row="0"
                                           Text="{Binding Prompt}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="White"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="2" />
                                    <Label Grid.Column="1" Grid.Row="1"
                                           Text="{Binding CreatedAt, StringFormat='{0:g}'}"
                                           FontSize="12"
                                           TextColor="Gray" />
                                    <HorizontalStackLayout Grid.Column="1" Grid.Row="2" Spacing="8">
                                        <Label Text="{Binding Seed, StringFormat='Seed: {0}'}" FontSize="11" TextColor="DimGray" />
                                        <Label Text="{Binding Files.Count, StringFormat='{0} files'}" FontSize="11" TextColor="DimGray" />
                                    </HorizontalStackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>

            <!-- Fatal State -->
            <VerticalStackLayout IsVisible="{Binding CurrentViewState, Converter={x:Static vm:GalleryViewStateConverters.IsFatal}}"
                                 VerticalOptions="Center" HorizontalOptions="Center" Spacing="16" Padding="32">
                <Label Text="âš " FontSize="48" HorizontalOptions="Center" TextColor="#FF6B6B" />
                <Label Text="Error"
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="#FF6B6B"
                       HorizontalOptions="Center" />
                <Label Text="{Binding ErrorMessage}"
                       FontSize="14"
                       TextColor="Gray"
                       HorizontalOptions="Center"
                       HorizontalTextAlignment="Center" />
                <Button Text="Browse Folder..."
                        Command="{Binding BrowseFolderCommand}"
                        BackgroundColor="#9B7DD4"
                        TextColor="White"
                        HorizontalOptions="Center"
                        Margin="0,16,0,0" />
                <Button Text="Refresh"
                        Command="{Binding RefreshCommand}"
                        BackgroundColor="#3D3D3D"
                        TextColor="White"
                        HorizontalOptions="Center" />
            </VerticalStackLayout>
        </Grid>

        <!-- Diagnostics Panel (Ctrl+Shift+D to toggle) -->
        <Frame Grid.Row="2"
               IsVisible="{Binding IsDiagnosticsVisible}"
               BackgroundColor="#1A1A1A"
               Padding="12"
               CornerRadius="0"
               Margin="0">
            <ScrollView MaximumHeightRequest="200">
                <Label Text="{Binding DiagnosticsText}"
                       FontFamily="Consolas"
                       FontSize="11"
                       TextColor="#D4D4D4"
                       LineBreakMode="NoWrap" />
            </ScrollView>
        </Frame>
    </Grid>
</ContentPage>
